<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel - ArturProgramming</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
body { font-family: 'Inter', sans-serif; margin: 0; background: #f8fafc; color: #1e293b; }
header { background: #2563eb; color: white; padding: 1rem; text-align: center; font-size: 1.5rem; font-weight: 700; }
main { max-width: 1200px; margin: 2rem auto; padding: 0 20px; }
h2 { margin-bottom: 1rem; }
.section { margin-bottom: 3rem; }
.grid { display: grid; grid-template-columns: repeat(auto-fill,minmax(300px,1fr)); gap: 1rem; }
.card { background: white; padding: 1rem; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
.card button { margin-top: 0.5rem; padding: 0.5rem 1rem; border: none; border-radius: 6px; cursor: pointer; }
.btn-primary { background: #2563eb; color: white; }
.btn-danger { background: #dc2626; color: white; }
.btn-secondary { background: #64748b; color: white; }
.modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); justify-content:center; align-items:center; padding:1rem; }
.modal.active { display:flex; }
.modal-content { background:white; padding:2rem; border-radius:12px; max-width:500px; width:100%; position:relative; display:flex; flex-direction:column; gap:0.5rem; }
.close-btn { position:absolute; top:10px; right:10px; cursor:pointer; font-size:1.2rem; }
input, textarea, select { padding:0.5rem; border:1px solid #e2e8f0; border-radius:6px; width:100%; }
</style>
</head>
<body>
<header>Admin Panel - ArturProgramming</header>
<main>
    <!-- Products -->
    <section class="section" id="products-section">
        <h2>Товары</h2>
        <button class="btn btn-primary" onclick="openAddModal('product')"><i class="fas fa-plus"></i> Добавить товар</button>
        <div id="products-grid" class="grid"></div>
    </section>

    <!-- Projects -->
    <section class="section" id="projects-section">
        <h2>Проекты</h2>
        <button class="btn btn-primary" onclick="openAddModal('project')"><i class="fas fa-plus"></i> Добавить проект</button>
        <div id="projects-grid" class="grid"></div>
    </section>

    <!-- News -->
    <section class="section" id="news-section">
        <h2>Новости</h2>
        <button class="btn btn-primary" onclick="openAddModal('news')"><i class="fas fa-plus"></i> Добавить новость</button>
        <div id="news-grid" class="grid"></div>
    </section>

    <!-- Logs -->
    <section class="section" id="logs-section">
        <h2>Логи действий</h2>
        <div id="logs-list" class="grid" style="grid-template-columns: 1fr;"></div>
    </section>
</main>

<!-- Modal -->
<div id="modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal()">&times;</span>
        <h3 id="modal-title"></h3>
        <input type="text" id="modal-name" placeholder="Название">
        <textarea id="modal-description" rows="4" placeholder="Описание"></textarea>
        <input type="text" id="modal-image" placeholder="URL изображения (необязательно)">
        <input type="text" id="modal-link" placeholder="Ссылка (необязательно)">
        <select id="modal-project-type" style="display:none;">
            <option value="unfinished">В разработке</option>
            <option value="finished">Завершённый</option>
        </select>
        <button class="btn btn-primary" id="modal-save-btn">Сохранить</button>
        <button class="btn btn-danger" id="modal-delete-btn" style="display:none;">Удалить</button>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getFirestore, collection, getDocs, addDoc, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAMR02-J6PKctO74M1pfVfa_rXFSXkT4Lc",
  authDomain: "site-ce0a8.firebaseapp.com",
  projectId: "site-ce0a8",
  storageBucket: "site-ce0a8.firebasestorage.app",
  messagingSenderId: "139414114128",
  appId: "1:139414114128:web:cad9db3573ecbc580da655",
  measurementId: "G-RVHT9SKK4K"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
let currentEdit = { type: null, id: null };
const logsList = document.getElementById('logs-list');

function addLog(message) {
    const logItem = document.createElement('div');
    logItem.className = 'card';
    const now = new Date();
    logItem.innerHTML = `<strong>[${now.toLocaleString()}]</strong> ${message}`;
    logsList.prepend(logItem);
}

// --- Create cards ---
function createCard(type, id, data) {
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
        <strong>${data.name || data.title}</strong>
        <p>${data.description || data.content || ''}</p>
        <button class="btn btn-secondary">Редактировать</button>
    `;
    card.querySelector('button').onclick = () => openEditModal(type, id, data);
    return card;
}

// --- Load collections ---
async function loadCollection(type) {
    const grid = document.getElementById(type + '-grid');
    grid.innerHTML = '';
    const colNames = type==='project' ? ['projects_unfinished','projects_finished'] : [type];
    for(const colName of colNames){
        try {
            const snapshot = await getDocs(collection(db, colName));
            snapshot.forEach(docSnap => grid.appendChild(createCard(type, docSnap.id, docSnap.data())));
        } catch(e) {
            addLog(`Ошибка при загрузке ${type}: ${e.message}`);
        }
    }
}

// --- Modal functions ---
function openAddModal(type) {
    currentEdit = { type, id: null };
    document.getElementById('modal-title').textContent = 'Добавить ' + type;
    document.getElementById('modal-name').value = '';
    document.getElementById('modal-description').value = '';
    document.getElementById('modal-image').value = '';
    document.getElementById('modal-link').value = '';
    document.getElementById('modal-project-type').style.display = type==='project'?'block':'none';
    document.getElementById('modal-delete-btn').style.display = 'none';
    document.getElementById('modal').classList.add('active');
}

function openEditModal(type, id, data) {
    currentEdit = { type, id };
    document.getElementById('modal-title').textContent = 'Редактировать ' + type;
    document.getElementById('modal-name').value = data.name || data.title || '';
    document.getElementById('modal-description').value = data.description || data.content || '';
    document.getElementById('modal-image').value = data.image || '';
    document.getElementById('modal-link').value = data.link || '';
    document.getElementById('modal-project-type').style.display = type==='project'?'block':'none';
    document.getElementById('modal-delete-btn').style.display = 'block';
    document.getElementById('modal').classList.add('active');
}

function closeModal() { document.getElementById('modal').classList.remove('active'); }

// --- Save / Delete ---
async function saveItem() {
    const name = document.getElementById('modal-name').value;
    const description = document.getElementById('modal-description').value;
    const image = document.getElementById('modal-image').value;
    const link = document.getElementById('modal-link').value;
    const type = currentEdit.type;
    const id = currentEdit.id;
    const colName = type==='project' ? document.getElementById('modal-project-type').value : type;

    const data = { name, description, image, link };
    try {
        if(id) {
            await updateDoc(doc(db, colName, id), data);
            addLog(`Изменён ${type} "${name}" (ID: ${id})`);
        } else {
            const docRef = await addDoc(collection(db, colName), data);
            addLog(`Добавлен ${type} "${name}" (ID: ${docRef.id})`);
        }
        closeModal();
        loadCollection(type);
    } catch(e) {
        addLog(`Ошибка при сохранении ${type}: ${e.message}`);
        alert('Ошибка при сохранении. Смотри логи.');
    }
}

async function deleteItem() {
    const type = currentEdit.type;
    const id = currentEdit.id;
    const colName = type==='project' ? document.getElementById('modal-project-type').value : type;
    if(!id) return;
    if(confirm('Удалить элемент?')) {
        try {
            await deleteDoc(doc(db, colName, id));
            addLog(`Удалён ${type} (ID: ${id})`);
            closeModal();
            loadCollection(type);
        } catch(e) {
            addLog(`Ошибка при удалении ${type}: ${e.message}`);
            alert('Ошибка при удалении. Смотри логи.');
        }
    }
}

document.getElementById('modal-save-btn').onclick = saveItem;
document.getElementById('modal-delete-btn').onclick = deleteItem;

// --- Initial load ---
loadCollection('product');
loadCollection('project');
loadCollection('news');
</script>
</body>
</html>
